<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLINK // OS - V2.2 ULTRA</title>
    <style>
        :root {
            --bg: #020502;
            --accent: #39ff14;
            --panel: rgba(10, 20, 10, 0.95);
            --border: rgba(57, 255, 20, 0.3);
            --text: #e0f0e0;
            --danger: #ff3333;
            --ui-glow: 0 0 15px rgba(57, 255, 20, 0.2);
            --sidebar-w: 280px;
        }

        /* --- THEMES --- */
        body.theme-red { --accent: #ff0000; --border: rgba(255, 0, 0, 0.3); --panel: rgba(20, 10, 10, 0.95); --ui-glow: 0 0 15px rgba(255, 0, 0, 0.2); }
        body.theme-blue { --accent: #00f2ff; --border: rgba(0, 242, 255, 0.3); --panel: rgba(5, 15, 25, 0.95); --ui-glow: 0 0 15px rgba(0, 242, 255, 0.2); }
        body.theme-gold { --accent: #ffdf00; --border: rgba(255, 223, 0, 0.3); --panel: rgba(25, 20, 5, 0.95); --ui-glow: 0 0 15px rgba(255, 223, 0, 0.2); }
        body.theme-void { --accent: #ffffff; --bg: #000000; --border: rgba(255, 255, 255, 0.5); --ui-glow: 0 0 25px rgba(255, 255, 255, 0.4); }

        * { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0; height: 100%;
            background: var(--bg); color: var(--text);
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            transition: background 0.5s ease;
        }

        #bg-canvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        
        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .auth-box {
            background: var(--panel); border: 1px solid var(--accent);
            padding: 40px; border-radius: 2px; width: 400px;
            text-align: center; box-shadow: var(--ui-glow);
            backdrop-filter: blur(10px);
        }

        /* --- LAYOUT --- */
        #app { display: none; height: 100vh; flex-direction: column; opacity: 0; transition: opacity 1s ease; }
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; height: 70px; background: rgba(0,0,0,0.9);
            border-bottom: 1px solid var(--border); z-index: 100;
        }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #sidebar {
            width: var(--sidebar-w); border-right: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
            background: rgba(0,0,0,0.3);
        }
        #content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }

        /* --- UI ELEMENTS --- */
        .btn {
            background: transparent; border: 1px solid var(--accent);
            color: var(--accent); padding: 10px 15px; cursor: pointer;
            border-radius: 0; font-weight: bold; text-transform: uppercase;
            transition: 0.2s; font-family: inherit;
        }
        .btn:hover { background: var(--accent); color: #000; box-shadow: var(--ui-glow); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        input, select {
            background: rgba(0,0,0,0.7); border: 1px solid var(--border);
            color: var(--accent); padding: 10px; margin: 10px 0; width: 100%;
            outline: none; font-family: inherit;
        }

        /* --- VIDEO GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .v-card {
            background: var(--panel); border: 1px solid var(--border);
            transition: 0.3s; cursor: pointer; position: relative;
        }
        .v-card:hover { border-color: var(--accent); transform: scale(1.02); }
        .v-thumb { width: 100%; aspect-ratio: 16/9; background: #000; object-fit: cover; border-bottom: 1px solid var(--border); }
        .v-info { padding: 12px; }
        .v-stats { font-size: 10px; opacity: 0.7; margin-top: 5px; }

        /* --- THEATER --- */
        #theater {
            position: fixed; inset: 0; background: #000; z-index: 500;
            display: none; grid-template-columns: 1fr 350px;
        }
        #player-box { background: #000; display: flex; flex-direction: column; }
        #player-ui { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        video { max-width: 100%; max-height: 100%; box-shadow: 0 0 50px rgba(0,0,0,1); }
        
        #comment-sidebar {
            background: var(--panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px;
        }
        #comment-list { flex: 1; overflow-y: auto; margin: 15px 0; font-size: 12px; }
        .comment-item { border-bottom: 1px solid rgba(57,255,20,0.1); padding: 8px 0; }

        #sys-msg {
            position: fixed; bottom: 20px; right: 20px;
            padding: 8px 15px; background: #000; border: 1px solid var(--accent);
            z-index: 1000; display: none; font-size: 12px;
        }

        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 10000;
        }
    </style>
</head>
<body onload="init()">

<canvas id="bg-canvas"></canvas>
<div class="scanline"></div>
<div id="sys-msg">STATUS: ONLINE</div>

<!-- Authentication -->
<div id="auth-screen">
    <div class="auth-box">
        <h1 style="color:var(--accent); letter-spacing: 8px; margin:0;">BLINK // OS</h1>
        <p style="font-size: 10px; opacity: 0.6; margin-bottom: 30px;">SECURE ACCESS GATEWAY V2.2</p>
        <input type="text" id="user-input" placeholder="[ IDENTITY_ID ]">
        <input type="password" id="pass-input" placeholder="[ SECURITY_CIPHER ]">
        <button class="btn" style="width: 100%; margin-top: 15px;" onclick="handleAuth()">LOGIN</button>
    </div>
</div>

<!-- Main App -->
<div id="app">
    <nav>
        <h2 style="letter-spacing: 4px; margin:0; font-size: 18px;">BLINK // OS</h2>
        <div style="display:flex; gap: 20px; align-items: center;">
            <button class="btn" onclick="openUpload()">TRANSMIT DATA</button>
            <span id="nav-user" style="color: var(--accent); font-size: 14px;"></span>
        </div>
    </nav>

    <div id="main-container">
        <div id="sidebar">
            <button class="btn" style="text-align: left;" onclick="setFeed('global')">> GLOBAL_STREAM</button>
            <button class="btn" style="text-align: left;" onclick="setFeed('trending')">> TRENDING_NODES</button>
            
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
                <label style="font-size: 10px; opacity: 0.5;">INTERFACE_SKIN</label>
                <select onchange="document.body.className = this.value">
                    <option value="">LITHIUM_GREEN</option>
                    <option value="theme-red">ALARM_RED</option>
                    <option value="theme-blue">CYBER_BLUE</option>
                    <option value="theme-void">VOID_WHITE</option>
                </select>
                <button class="btn" style="width: 100%; margin-top: 10px; color: var(--danger); border-color: var(--danger);" onclick="location.reload()">TERMINATE_SESSION</button>
            </div>
        </div>

        <div id="content">
            <h3 id="feed-title" style="border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top:0;">ACCESSING: GLOBAL_STREAM</h3>
            <div id="video-grid" class="grid"></div>
        </div>
    </div>
</div>

<!-- Theater Mode -->
<div id="theater">
    <div id="player-box">
        <div style="padding: 10px 20px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-between; border-bottom: 1px solid var(--border);">
            <button class="btn" onclick="closeTheater()">EXIT_THEATER</button>
            <h4 id="theater-title" style="margin: 0; color: var(--accent); align-self: center; letter-spacing: 2px;"></h4>
        </div>
        <div id="player-ui">
            <video id="main-video" controls autoplay></video>
        </div>
        <div style="padding: 20px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
            <div>
                <button id="blink-btn" class="btn" onclick="addBlink()">BLINK [ <span id="blink-count">0</span> ]</button>
            </div>
            <div id="theater-author" style="font-size: 12px; opacity: 0.7;"></div>
        </div>
    </div>
    
    <div id="comment-sidebar">
        <h5 style="margin:0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px;">DATA_COMMENTS</h5>
        <div id="comment-list"></div>
        <div style="display:flex; gap: 5px;">
            <input type="text" id="com-input" placeholder="Add entry..." style="margin:0;">
            <button class="btn" onclick="addComment()">SEND</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, increment, query, arrayUnion } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    /* --- GITHUB PAGES FIREBASE CONFIG ---
      Replace the values below with the ones from your Firebase Console.
      Path: Project Settings -> General -> Your Apps -> Web App (SDK Setup and Config)
    */
    const myFirebaseConfig = {
        apiKey: "AIzaSyDf6xMlCv_FeM6OWyQZcDPiZgazvWAgLQY",
        authDomain: "blink-os.firebaseapp.com",
        projectId: "blink-os",
        storageBucket: "blink-os.firebasestorage.app",
        messagingSenderId: "111563521938",
        appId: "1:111563521938:web:46b4650d6de68f97164b4b"
    };

    // Environment Detection: Uses Canvas config if available, otherwise uses yours
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'blink-os-live-node';

    let userSession = null;
    let videos = [];
    let currentVideoId = null;
    let currentFeed = 'global';
    let videosUnsubscribe = null;

    // Background Canvas Animation
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    function draw() {
        ctx.fillStyle = 'rgba(2, 5, 2, 0.15)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
        for(let i=0; i<15; i++) {
            ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 1, 1);
        }
        requestAnimationFrame(draw);
    }
    draw();

    // Critical Auth Initialization
    window.init = async () => {
        try {
            // Priority 1: Canvas/Environment Auth
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                // Priority 2: Anonymous Login for your own GitHub Pages site
                await signInAnonymously(auth);
            }
        } catch (e) { 
            console.error("Auth Failure. Ensure Anonymous Auth is enabled in your Firebase Dashboard.", e);
        }
    };

    // Watch for Auth to trigger data listeners
    onAuthStateChanged(auth, (user) => {
        if (user) {
            setupDataSync();
            const sys = document.getElementById('sys-msg');
            sys.innerText = "STATUS: CONNECTION SECURE";
            sys.style.display = "block";
        }
    });

    function setupDataSync() {
        if (videosUnsubscribe) videosUnsubscribe();
        
        // Firestore Path Rule: /artifacts/{appId}/public/data/{collection}
        const vCol = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
        
        videosUnsubscribe = onSnapshot(vCol, (snap) => {
            videos = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderVideos();
            if (currentVideoId) updateTheaterUI();
        }, (err) => {
            console.error("Sync Error. Check Firestore Rules and Config:", err);
            const sys = document.getElementById('sys-msg');
            sys.innerText = "ERROR: CLOUD SYNC FAILED";
            sys.style.color = "var(--danger)";
        });
    }

    window.handleAuth = () => {
        const id = document.getElementById('user-input').value.trim();
        if (!id) return;
        userSession = { username: id.toLowerCase() };
        document.getElementById('nav-user').innerText = `USER: ${id.toUpperCase()}`;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        setTimeout(() => document.getElementById('app').style.opacity = '1', 50);
    };

    window.setFeed = (type) => {
        currentFeed = type;
        document.getElementById('feed-title').innerText = `ACCESSING: ${type.toUpperCase()}_STREAM`;
        renderVideos();
    };

    function renderVideos() {
        const grid = document.getElementById('video-grid');
        grid.innerHTML = '';
        
        let displayList = [...videos];
        
        if (currentFeed === 'trending') {
            displayList.sort((a,b) => {
                const scoreA = (a.blinks || 0) + (a.comments?.length || 0);
                const scoreB = (b.blinks || 0) + (b.comments?.length || 0);
                return scoreB - scoreA;
            });
        } else {
            displayList.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        }

        displayList.forEach(v => {
            const el = document.createElement('div');
            el.className = 'v-card';
            el.onclick = () => openTheater(v.id);
            const thumbColor = getComputedStyle(document.body).getPropertyValue('--accent').trim().replace('#', '');
            el.innerHTML = `
                <img class="v-thumb" src="https://via.placeholder.com/400x225/000/${thumbColor}/?text=NODE_${v.id.substring(0,4)}">
                <div class="v-info">
                    <div style="font-weight:bold; color:var(--accent); text-transform:uppercase;">${v.title}</div>
                    <div style="font-size:10px; opacity:0.5;">SOURCE: ${v.author}</div>
                    <div class="v-stats">BLINKS: ${v.blinks || 0} // COMMS: ${v.comments?.length || 0}</div>
                </div>
            `;
            grid.appendChild(el);
        });
    }

    window.openTheater = (id) => {
        currentVideoId = id;
        const v = videos.find(x => x.id === id);
        if (!v) return;

        document.getElementById('theater-title').innerText = v.title.toUpperCase();
        document.getElementById('theater-author').innerText = `NODE_ORIGIN: ${v.author}`;
        const vidElement = document.getElementById('main-video');
        vidElement.src = v.url;
        document.getElementById('theater').style.display = 'grid';
        updateTheaterUI();
    };

    function updateTheaterUI() {
        const v = videos.find(x => x.id === currentVideoId);
        if (!v) return;
        
        document.getElementById('blink-count').innerText = v.blinks || 0;
        const list = document.getElementById('comment-list');
        list.innerHTML = (v.comments || []).map(c => `
            <div class="comment-item">
                <span style="color:var(--accent)">[${c.user}]</span>: ${c.text}
            </div>
        `).join('');
        list.scrollTop = list.scrollHeight;
    }

    window.closeTheater = () => {
        const vid = document.getElementById('main-video');
        vid.pause();
        document.getElementById('theater').style.display = 'none';
        currentVideoId = null;
    };

    window.addBlink = async () => {
        if (!currentVideoId || !auth.currentUser) return;
        const btn = document.getElementById('blink-btn');
        btn.disabled = true;
        try {
            const vRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', currentVideoId);
            await updateDoc(vRef, { blinks: increment(1) });
        } catch (e) { console.error(e); }
        btn.disabled = false;
    };

    window.addComment = async () => {
        const input = document.getElementById('com-input');
        const text = input.value.trim();
        if (!text || !currentVideoId || !auth.currentUser) return;

        try {
            const vRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', currentVideoId);
            await updateDoc(vRef, {
                comments: arrayUnion({
                    user: userSession.username,
                    text: text,
                    time: Date.now()
                })
            });
            input.value = '';
        } catch (e) { console.error(e); }
    };

    window.openUpload = async () => {
        if (!auth.currentUser) return;
        const title = prompt("ENTER TRANSMISSION TITLE:");
        const url = prompt("ENTER DATA URL (Direct MP4 Link):");
        if (title && url) {
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), {
                    title, url, author: userSession.username, timestamp: Date.now(),
                    blinks: 0, comments: []
                });
            } catch (e) { console.error("Broadcast failed:", e); }
        }
    };
</script>
</body>
</html>